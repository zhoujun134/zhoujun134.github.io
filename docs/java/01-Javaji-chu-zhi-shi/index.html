<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-java/01-Javaji-chu-zhi-shi" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">01-Java基础知识 | Z 不殊</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zbus.top/docs/java/01-Javaji-chu-zhi-shi"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="01-Java基础知识 | Z 不殊"><meta data-rh="true" name="description" content="## 1. 注意 equals 和 == 的区别"><meta data-rh="true" property="og:description" content="## 1. 注意 equals 和 == 的区别"><meta data-rh="true" property="og:image" content="https://img.zbus.top/zbus/blog202403150008819.webp"><meta data-rh="true" name="twitter:image" content="https://img.zbus.top/zbus/blog202403150008819.webp"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zbus.top/docs/java/01-Javaji-chu-zhi-shi"><link data-rh="true" rel="alternate" href="https://zbus.top/docs/java/01-Javaji-chu-zhi-shi" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://zbus.top/docs/java/01-Javaji-chu-zhi-shi" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KNKL89273C-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-141789564-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Z 不殊" href="/opensearch.xml">



<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?3fe9ea74bd372ee22bcbf0caaf670701";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<link rel="icon" href="/img/logo.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#12affa">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Z 不殊 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Z 不殊 Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Z 不殊 JSON Feed">

<meta name="Z 不殊" content="Z 不殊的个人博客">
<meta name="快跑小火车" content="Z 不殊的个人博客">
<meta name="baidu-site-verification" content="codeva-q5wJCLbMma">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/misans@4.0.0/lib/Normal/MiSans-Normal.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/misans@4.0.0/lib/Normal/MiSans-Semibold.min.css"><link rel="stylesheet" href="/assets/css/styles.a71371cb.css">
<script src="/assets/js/runtime~main.9caf4a71.js" defer="defer"></script>
<script src="/assets/js/main.874beb7b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo.jpg" alt="Z 不殊 Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/logo.jpg" alt="Z 不殊 Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Z 不殊</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">文档</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/blog">博客</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/blog">博客列表</a></li><li><a class="dropdown__link" href="/blog/archive">归档</a></li></ul></div><a class="navbar__item navbar__link" href="/friends">友链</a><a class="navbar__item navbar__link" href="/project">项目</a><a class="navbar__item navbar__link" href="/about">关于我</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zhoujun134" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/logo.jpg" alt="Z 不殊 Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/logo.jpg" alt="Z 不殊 Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b>Z 不殊</b></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">介绍</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/刷题笔记">刷题笔记</a><button aria-label="展开侧边栏分类 &#x27;刷题笔记&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/java-基础">Java 基础</a><button aria-label="折叠侧边栏分类 &#x27;Java 基础&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/java/01-Javaji-chu-zhi-shi">01-Java基础知识</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/02-javazheng-ze-biao-da-shi">02-java正则表达式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/03-Javafan-she">03-Java反射</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/04-mutil-thread-01">04-Java 多线程知识汇总（一）wait, notify, notifyAll, join，yeild, interrupt</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/04-mutil-thread-02">04-Java 多线程知识汇总（二）内存可见问题，线程死锁，volatile</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/06-2024-07-16-00-25-17-java-CompletableFuture">05-CompletableFuture 由浅入深</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/06-java-function-interface">06-java 函数式接口</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/07-2024-07-25-22-10-23-06-zuo-you-yi">07-Java中的 `&lt;&lt; ， &gt;&gt;` ， 和 `&gt;&gt;&gt;`所代表的含义</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/java/设计模式/2024-07-21 14:22:07-设计模式">设计模式</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/分布式服务">分布式服务</a><button aria-label="展开侧边栏分类 &#x27;分布式服务&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/docusaurus-魔改之路">Docusaurus 魔改之路</a><button aria-label="展开侧边栏分类 &#x27;Docusaurus 魔改之路&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/git-使用手册">git 使用手册</a><button aria-label="展开侧边栏分类 &#x27;git 使用手册&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/flexmark框架">flexmark框架</a><button aria-label="展开侧边栏分类 &#x27;flexmark框架&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/nginx">nginx</a><button aria-label="展开侧边栏分类 &#x27;nginx&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/后端面试相关java">后端面试相关（java）</a><button aria-label="展开侧边栏分类 &#x27;后端面试相关（java）&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/linux">linux</a><button aria-label="展开侧  边栏分类 &#x27;linux&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/工具日志">工具日志</a><button aria-label="展开侧边栏分类 &#x27;工具日志&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/前端">前端</a><button aria-label="展开侧边栏分类 &#x27;前端&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kafka">kafka</a><button aria-label="展开侧边栏分类 &#x27;kafka&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/java-基础"><span itemprop="name">Java 基础</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">01-Java基础知识</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>01-Java基础知识</h1></header><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-注意-equals-和--的区别">1. 注意 equals 和 == 的区别<a class="hash-link" aria-label="1. 注意 equals 和 == 的区别的直接链接" title="1. 注意 equals 和 == 的区别的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#1-注意-equals-和--的区别">​</a></h2>
<p><strong>比较值的内容，除了基本类型只能使用 == 外，其他类型都需要使用 equals。</strong></p>
<ul>
<li>对基本类型，比如 int，long，进行判等，只能使用 ==，比较的是直接值。因为基本类型的值就是其数值。</li>
<li>对引用类型，比如 Integer，Long 和 String，进行判等，需要使用 equals 进行内容判等。因为引用类型的直接值是指针，使用 == 的话，比较的是指针，也就是两个对象在内存中的地址，即比较它们是不是同一个对象，而不是比较对象的内容。</li>
</ul>
<blockquote>
<p>重写equals 应该注意的点</p>
<ul>
<li>考虑到性能，可以先进行指针判等，如果对象是同一个那么直接返回 true；</li>
<li>需要对另一方进行判空，空对象和自身进行比较，结果一定是 fasle；</li>
<li> 需要判断两个对象的类型，如果类型都不同，那么直接返回 false；</li>
<li>确保类型相同的情况下再进行类型强制转换，然后逐一判断所有字段。</li>
<li>hashCode 和 equals 要配对实现</li>
</ul>
</blockquote>
<blockquote>
<p>关于equals其实还有一个大坑，equals比较的对象除了所谓的相等外，还有一个非常重要的因素，就是该对象的类加载器也必须是同一个，不然equals返回的肯定是false；之前遇到过一个坑：重启后，两个对象相等，结果是true，但是修改了某些东西后，热加载（不用重启即可生效）后，再次执行equals，返回就是false，因为热加载使用的类加载器和程序正常启动的类加载器不同。关于类加载器部分，JDK 9 之前的 Java 应用都是由「启动类加载器」、「扩展类加载器」、「应用程序类加载器」这三种类加载器互相配合来完成加载的，如果有需要还可以加入自定义的类加载器来进行拓展；JDK 9 为了模块化的支持，对双亲委派模式做了一些改动：扩展类加载器被平台类加载器（Platform ClassLoader）取代。平台类加载器和应用程序类加载器都不再继承自 java.net.URLClassLoader，而是继承于 jdk.internal.loader.BuiltinClassLoader。具体细节可以自行搜索。</p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-integer-的内部做了缓存-">2. Integer 的内部做了缓存 。<a class="hash-link" aria-label="2. Integer 的内部做了缓存 。的直接链接" title="2. Integer 的内部做了缓存 。的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#2-integer-的内部做了缓存-">​</a></h2>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Integer</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">valueOf</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">i </span><span class="token operator" style="color:#66d9ef">&gt;=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IntegerCache</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">low </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> i </span><span class="token operator" style="color:#66d9ef">&lt;=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IntegerCache</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">high</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IntegerCache</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">cache</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">i </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">-</span><span class="token class-name" style="color:#e6db74">IntegerCache</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">low</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Integer</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></span><br></span></code></pre></div></div>
<p>默认情况下会缓存[-128, 127]的数值，而 128 处于这个区间之外。</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IntegerCache</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">final</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> low </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">128</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">final</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> high</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// high value may be configured by property==</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> h </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">127</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">String</span><span class="token plain"> integerCacheHighPropValue </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            sun</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">misc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">VM</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">getSavedProperty</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;java.lang.Integer.IntegerCache.high&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">integerCacheHighPropValue </span><span class="token operator" style="color:#66d9ef">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> i </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">parseInt</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">integerCacheHighPropValue</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                i </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Math</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">max</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">127</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                </span><span class="token comment" style="color:#8292a2;font-style:italic">// Maximum array size is Integer.MAX_VALUE</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                h </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Math</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">min</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Integer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">MAX_VALUE</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain">low</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">catch</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">NumberFormatException</span><span class="token plain"> nfe</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                </span><span class="token comment" style="color:#8292a2;font-style:italic">// If the property cannot be parsed into an int, ignore it.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        high </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> h</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        cache </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Integer</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">high </span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain"> low</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> j </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> low</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">for</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> k </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> k </span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> k</span><span class="token operator" style="color:#66d9ef">++</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            cache</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">k</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Integer</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">j</span><span class="token operator" style="color:#66d9ef">++</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token comment" style="color:#8292a2;font-style:italic">// range [-128, 127] must be interned (JLS7 5.1.7)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">assert</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IntegerCache</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">high </span><span class="token operator" style="color:#66d9ef">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">127</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></span><br></span></code></pre></div></div>
<p>可以看到最大值，可以通过配置进行配置。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3--getclass-和-instanceof-的区别">3.  getClass 和 instanceof 的区别<a class="hash-link" aria-label="3.  getClass 和 instanceof 的区别的直接链接" title="3.  getClass 和 instanceof 的区别的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#3--getclass-和-instanceof-的区别">​</a></h2>
<p>使用 getClass 和 instanceof 这两种方案都是可以判断对象类型的。它们的区别就是，getClass 限制了这两个对象只能属于同一个类，而 instanceof 却允许两个对象是同一个类或其子类。正是因为这种区别，不同的人对这两种方案有不同的喜好，争论也很多。在我看来，你只需要根据自己的要求去选择。补充说明一下，Lombok 使用的是 instanceof 的方案。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-string-相关">4. String 相关<a class="hash-link" aria-label="4. String 相关的直接链接" title="4. String 相关的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#4-string-相关">​</a></h2>
<p><strong>Java 的字符串常量池机制</strong>。首先要明确的是其设计初衷是节省内存。当代码中出现双引号形式创建字符串对象时，JVM 会先对这个字符串进行检查，如果字符串常量池中存在相同内容的字符串对象的引用，则将这个引用返回；否则，创建新的字符串对象，然后将这个引用放入字符串常量池，并返回该引用。这种机制，就是字符串驻留或池化。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41-string-长度限制">4.1 String 长度限制<a class="hash-link" aria-label="4.1 String 长度限制的直接链接" title="4.1 String 长度限制的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#41-string-长度限制">​</a></h3>
<p>String 内部是以char数组的形式存储，数组的长度是int类型，那么String允许的最大长度就是 Integer.MAX_VALUE 了。又由于java中的字符是以16位存储的，因此大概需要4GB的内存才能存储最大长度的字符串。不过这仅仅是对字符串变量而言，如果是字符串字面量(string literals)，如“abc&quot;、&quot;1a2b&quot;之类写在代码中的字符串literals，那么允许的最大长度取决于字符串在常量池中的存储大小，也就是字符串在class格式文件中的存储格式：</p>
<div class="language-shell codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->shell<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-shell codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">CONSTANT_Utf8_info </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    u1 tag</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    u2 length</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    u1 bytes</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">length</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></span><br></span></code></pre></div></div>
<p>u2 是无符号的16位整数，因此理论上允许的string literal的最大长度是2^16=65536。然而实际测试表明，允许的最大长度仅为65534，超过就编译错误了。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-危险的-double--bigdecimal">5 “危险”的 Double--BigDecimal<a class="hash-link" aria-label="5 “危险”的 Double--BigDecimal的直接链接" title="5 “危险”的 Double--BigDecimal的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#5-危险的-double--bigdecimal">​</a></h2>
<blockquote>
<p>第一，切记，要精确表示浮点数应该使用 BigDecimal。并且，使用 BigDecimal 的 Double 入参的构造方法同样存在精度丢失问题，应该使用 String 入参的构造方法或者 BigDecimal.valueOf 方法来初始化。</p>
<p>第二，对浮点数做精确计算，参与计算的各种数值应该始终使用 BigDecimal，所有的计算都要通过 BigDecimal 的方法进行，切勿只是让 BigDecimal 来走过场。任何一个环节出现精度损失，最后的计算结果可能都会出现误差。</p>
<p>第三，对于浮点数的格式化，如果使用 String.format 的话，需要认识到它使用的是四舍五入，可以考虑使用 DecimalFormat 来明确指定舍入方式。但考虑到精度问题，我更建议使用 BigDecimal 来表示浮点数，并使用其 setScale 方法指定舍入的位数和方式。</p>
<p>第四，进行数值运算时要小心溢出问题，虽然溢出后不会出现异常，但得到的计算结果是完全错误的。我们考虑使用 Math.xxxExact 方法来进行运算，在溢出时能抛出异常，更建议对于可能会出现溢出的大数运算使用 BigInteger 类。</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="51-使用-bigdecimal-表示和计算浮点数且务必使用字符串的构造方法来初始化-bigdecimal">5.1 使用 BigDecimal 表示和计算浮点数，且务必使用字符串的构造方法来初始化 BigDecimal<a class="hash-link" aria-label="5.1 使用 BigDecimal 表示和计算浮点数，且务必使用字符串的构造方法来初始化 BigDecimal的直接链接" title="5.1 使用 BigDecimal 表示和计算浮点数，且务必使用字符串的构造方法来初始化 BigDecimal的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#51-使用-bigdecimal-表示和计算浮点数且务必使用字符串的构造方法来初始化-bigdecimal">​</a></h3>
<p><strong>使用 BigDecimal 表示和计算浮点数，且务必使用字符串的构造方法来初始化 BigDecimal：</strong></p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">0.1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">0.2</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1.0</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">subtract</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">0.8</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">4.015</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">multiply</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">100</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">123.3</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">divide</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">100</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span></span><br></span></code></pre></div></div>
<p>输出如下：</p>
<div class="language-bash codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->bash<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-bash codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token number" style="color:#ae81ff">0.3000000000000000166533453693773481063544750213623046875</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token number" style="color:#ae81ff">0.1999999999999999555910790149937383830547332763671875</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token number" style="color:#ae81ff">401.49999999999996802557689079549163579940795898437500</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token number" style="color:#ae81ff">1.232999999999999971578290569595992565155029296875</span></span><br></span></code></pre></div></div>
<p>可以看到，运算结果还是不精确，只不过是精度高了而已。这里给出浮点数运算避坑第一原则：<strong>使用 BigDecimal 表示和计算浮点数，且务必使用字符串的构造方法来初始化 BigDecimal：</strong></p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;0.1&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;0.2&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;1.0&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">subtract</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;0.8&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;4.015&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">multiply</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;100&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;123.3&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">divide</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;100&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span></span><br></span></code></pre></div></div>
<p>改进后，就能得到我们想要的输出了：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token number" style="color:#ae81ff">0.3</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token number" style="color:#ae81ff">0.2</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token number" style="color:#ae81ff">401.500</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token number" style="color:#ae81ff">1.233</span></span><br></span></code></pre></div></div>
<p><strong>BigDecimal 有 scale 和 precision 的概念，scale 表示小数点右边的位数，而 precision 表示精度，也就是有效数字的长度。</strong></p>
<p>BigDecimal 的 toString 方法得到的字符串和 scale 相关，又会引出了另一个问题：对于浮点数的字符串形式输出和格式化，我们应该考虑显式进行，通过格式化表达式或格式化工具来明确小数位数和舍入方式。</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token keyword" style="color:#66d9ef">double</span><span class="token plain"> num1 </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">3.35</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">float</span><span class="token plain"> num2 </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">3.35f</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">String</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">format</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;%.1f&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> num1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token comment" style="color:#8292a2;font-style:italic">//四舍五入</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">String</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">format</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;%.1f&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> num2</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span></span><br></span></code></pre></div></div>
<p>得到的结果居然是 3.4 和 3.3。</p>
<p>  这就是由精度问题和舍入方式共同导致的，double 和 float 的 3.35 其实相当于 3.350xxx 和 3.349xxx：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token number" style="color:#ae81ff">3.350000000000000088817841970012523233890533447265625</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token number" style="color:#ae81ff">3.349999904632568359375</span></span><br></span></code></pre></div></div>
<p>String.format 采用四舍五入的方式进行舍入，取 1 位小数，double 的 3.350 四舍五入为 3.4，而 float 的 3.349 四舍五入为 3.3。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="52-浮点数的字符串格式化也要通过-bigdecimal-进行">5.2 <strong>浮点数的字符串格式化也要通过 BigDecimal 进行。</strong><a class="hash-link" aria-label="52-浮点数的字符串格式化也要通过-bigdecimal-进行的直接链接" title="52-浮点数的字符串格式化也要通过-bigdecimal-进行的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#52-浮点数的字符串格式化也要通过-bigdecimal-进行">​</a></h3>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token plain"> num1 </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;3.35&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token plain"> num2 </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> num1</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">setScale</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">ROUND_DOWN</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">num2</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token plain"> num3 </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> num1</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">setScale</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">ROUND_HALF_UP</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">num3</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span></span><br></span></code></pre></div></div>
<p>这次得到的结果是 3.3 和 3.4，符合预期。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="53-用-equals-做判等注意bigdecimal-的判等方式">5.3 用 equals 做判等，注意BigDecimal 的判等方式。<a class="hash-link" aria-label="5.3 用 equals 做判等，注意BigDecimal 的判等方式。的直接链接" title="5.3 用 equals 做判等，注意BigDecimal 的判等方式。的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#53-用-equals-做判等注意bigdecimal-的判等方式">​</a></h3>
<p>包装类的比较要通过 equals 进行，而不能使用 ==。那么，使用 equals 方法对两个 BigDecimal 判等，使用 equals 方法对两个 BigDecimal 判等，不一定能得到我们想要的结果。比如：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;1.0&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">equals</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;1&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span></span><br></span></code></pre></div></div>
<p>结果当然是 false。==<strong>BigDecimal 的 equals 方法的注释中说明了原因，equals 比较的是 BigDecimal 的 value 和 scale</strong>，==1.0 的 scale 是 1，1 的 scale 是 0，所以结果一定是 false：</p>
<p>**如果我们希望只比较 BigDecimal 的 value，可以使用 compareTo 方法，**修改后代码如下：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;1.0&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">compareTo</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;1&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#66d9ef">==</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span></span><br></span></code></pre></div></div>
<p>BigDecimal 的 equals 和 hashCode 方法会同时考虑 value 和 scale，如果结合 HashSet 或 HashMap 使用的话就可能会出现麻烦。比如，我们把值为 1.0 的 BigDecimal 加入 HashSet，然后判断其是否存在值为 1 的 BigDecimal，得到的结果是 false：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token class-name" style="color:#e6db74">Set</span><span class="token generics punctuation" style="color:#f8f8f2">&lt;</span><span class="token generics class-name" style="color:#e6db74">BigDecimal</span><span class="token generics punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> hashSet1 </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">HashSet</span><span class="token generics punctuation" style="color:#f8f8f2">&lt;</span><span class="token generics punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">hashSet1</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;1.0&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">hashSet1</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">contains</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;1&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token comment" style="color:#8292a2;font-style:italic">//返回false</span></span><br></span></code></pre></div></div>
<p>解决这个问题的办法有两个：</p>
<ul>
<li>第一个方法是，使用 TreeSet 替换 HashSet。TreeSet 不使用 hashCode 方法，也不使用 equals 比较元素，而是使用 compareTo 方法，所以不会有问题。</li>
</ul>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token class-name" style="color:#e6db74">Set</span><span class="token generics punctuation" style="color:#f8f8f2">&lt;</span><span class="token generics class-name" style="color:#e6db74">BigDecimal</span><span class="token generics punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> treeSet </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">TreeSet</span><span class="token generics punctuation" style="color:#f8f8f2">&lt;</span><span class="token generics punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">treeSet</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;1.0&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">treeSet</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">contains</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;1&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token comment" style="color:#8292a2;font-style:italic">//返回true</span></span><br></span></code></pre></div></div>
<ul>
<li>第二个方法是，把 BigDecimal 存入 HashSet 或 HashMap 前，先使用 stripTrailingZeros 方法去掉尾部的零，比较的时候也去掉尾部的 0，确保 value 相同的 BigDecimal，scale 也是一致的：</li>
</ul>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token class-name" style="color:#e6db74">Set</span><span class="token generics punctuation" style="color:#f8f8f2">&lt;</span><span class="token generics class-name" style="color:#e6db74">BigDecimal</span><span class="token generics punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> hashSet2 </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">HashSet</span><span class="token generics punctuation" style="color:#f8f8f2">&lt;</span><span class="token generics punctuation" style="color:#f8f8f2">&gt;</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">hashSet2</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;1.0&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">stripTrailingZeros</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">hashSet2</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">contains</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigDecimal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;1.000&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">stripTrailingZeros</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token comment" style="color:#8292a2;font-style:italic">//返回true</span></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="54-小心数值溢出问题">5.4 小心数值溢出问题<a class="hash-link" aria-label="5.4 小心数值溢出问题的直接链接" title="5.4 小心数值溢  出问题的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#54-小心数值溢出问题">​</a></h3>
<p>数值计算还有一个要小心的点是溢出，不管是 int 还是 long，所有的基本数值类型都有超出表达范围的可能性。</p>
<p>比如，对 Long 的最大值进行 +1 操作：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> l </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Long</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">MAX_VALUE</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Long</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">MIN_VALUE</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span></span><br></span></code></pre></div></div>
<p>输出结果是一个负数，因为 Long 的最大值 +1 变为了 Long 的最小值：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">9223372036854775808</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token boolean" style="color:#ae81ff">true</span></span><br></span></code></pre></div></div>
<p>**显然这是发生了溢出，而且是默默地溢出，并没有任何异常。**这类问题非常容易被忽略，改进方式有下面 2 种。</p>
<p>方法一是，考虑使用 Math 类的 addExact、subtractExact 等 xxExact 方法进行数值运算，这些方法可以在数值溢出时主动抛出异常。我们来测试一下，使用 Math.addExact 对 Long 最大值做 +1 操作：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自 动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token keyword" style="color:#66d9ef">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> l </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Long</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">MAX_VALUE</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">Math</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">addExact</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    ex</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">printStackTrace</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></span><br></span></code></pre></div></div>
<p>执行后，可以得到 ArithmeticException，这是一个 RuntimeException：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">java</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">lang</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name" style="color:#e6db74">ArithmeticException</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> overflow</span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">  at </span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">java</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">lang</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name" style="color:#e6db74">Math</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">addExact</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">Math</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">java</span><span class="token operator" style="color:#66d9ef">:</span><span class="token number" style="color:#ae81ff">809</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">  at </span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">org</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">geekbang</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">time</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">commonmistakes</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">numeralcalculations</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">demo3</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name" style="color:#e6db74">CommonMistakesApplication</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">right2</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">CommonMistakesApplication</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">java</span><span class="token operator" style="color:#66d9ef">:</span><span class="token number" style="color:#ae81ff">25</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">  at </span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">org</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">geekbang</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">time</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">commonmistakes</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">numeralcalculations</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">demo3</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name" style="color:#e6db74">CommonMistakesApplication</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">main</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">CommonMistakesApplication</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">java</span><span class="token operator" style="color:#66d9ef">:</span><span class="token number" style="color:#ae81ff">13</span><span class="token punctuation" style="color:#f8f8f2">)</span></span><br></span></code></pre></div></div>
<p>方法二是，使用大数类 BigInteger。BigDecimal 是处理浮点数的专家，而 BigInteger 则是对大数进行科学计算的专家。</p>
<p>如下代码，使用 BigInteger 对 Long 最大值进行 +1 操作；如果希望把计算结果转换一个 Long 变量的话，可以使用 BigInteger 的 longValueExact 方法，在转换出现溢出时，同样会抛出 ArithmeticException：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token class-name" style="color:#e6db74">BigInteger</span><span class="token plain"> i </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigInteger</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">String</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">valueOf</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">Long</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">MAX_VALUE</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">BigInteger</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">ONE</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">toString</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> l </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">BigInteger</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">ONE</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">longValueExact</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    ex</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">printStackTrace</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></span><br></span></code></pre></div></div>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token number" style="color:#ae81ff">9223372036854775808</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">java</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">lang</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name" style="color:#e6db74">ArithmeticException</span><span class="token operator" style="color:#66d9ef">:</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">BigInteger</span><span class="token plain"> out of </span><span class="token keyword" style="color:#66d9ef">long</span><span class="token plain"> range</span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">  at </span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">java</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">math</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name" style="color:#e6db74">BigInteger</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">longValueExact</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">BigInteger</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">java</span><span class="token operator" style="color:#66d9ef">:</span><span class="token number" style="color:#ae81ff">4632</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">  at </span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">org</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">geekbang</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">time</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">commonmistakes</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">numeralcalculations</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">demo3</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name" style="color:#e6db74">CommonMistakesApplication</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">right1</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">CommonMistakesApplication</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">java</span><span class="token operator" style="color:#66d9ef">:</span><span class="token number" style="color:#ae81ff">37</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">  at </span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">org</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">geekbang</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">time</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">commonmistakes</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">numeralcalculations</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name namespace" style="color:rgb(178, 204, 214);opacity:0.7">demo3</span><span class="token class-name namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token class-name" style="color:#e6db74">CommonMistakesApplication</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">main</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">CommonMistakesApplication</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">java</span><span class="token operator" style="color:#66d9ef">:</span><span class="token number" style="color:#ae81ff">11</span><span class="token punctuation" style="color:#f8f8f2">)</span></span><br></span></code></pre></div></div>
<p>可以看到，通过 BigInteger 对 Long 的最大值加 1 一点问题都没有，当尝试把结果转换为 Long 类型时，则会提示 BigInteger out of long range。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="55-bigdecimal提供了-8-种舍入模式">5.5 BigDecimal提供了 8 种舍入模式<a class="hash-link" aria-label="5.5 BigDecimal提供了 8 种舍入模式的直接链接" title="5.5 BigDecimal提供了 8 种舍入模式的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#55-bigdecimal提供了-8-种舍入模式">​</a></h3>
<p>第一种，ROUND_UP，舍入远离零的舍入模式，在丢弃非零部分之前始终增加数字（始终对非零舍弃部分前面的数字加 1）。 需要注意的是，此舍入模式始终不会减少原始值。</p>
<p>第二种，ROUND_DOWN，接近零的舍入模式，在丢弃某部分之前始终不增加数字（从不对舍弃部分前面的数字加 1，即截断）。 需要注意的是，此舍入模式始终不会增加原始值。</p>
<p>第三种，ROUND_CEILING，接近正无穷大的舍入模式。 如果 BigDecimal 为正，则舍入行为与 ROUND_UP 相同； 如果为负，则舍入行为与 ROUND_DOWN 相同。 需要注意的是，此舍入模式始终不会减少原始值。</p>
<p>第四种，ROUND_FLOOR，接近负无穷大的舍入模式。 如果 BigDecimal 为正，则舍入行为与 ROUND_DOWN 相同； 如果为负，则舍入行为与 ROUND_UP 相同。 需要注意的是，此舍入模式始终不会增加原始值。</p>
<p>第五种，ROUND_HALF_UP，向“最接近的”数字舍入。如果舍弃部分 &gt;= 0.5，则舍入行为与 ROUND_UP 相同；否则，舍入行为与 ROUND_DOWN 相同。 需要注意的是，这是我们大多数人在小学时就学过的舍入模式（四舍五入）。</p>
<p>第六种，ROUND_HALF_DOWN，向“最接近的”数字舍入。如果舍弃部分 &gt; 0.5，则舍入行为与 ROUND_UP 相同；否则，舍入行为与 ROUND_DOWN 相同（五舍六入）。</p>
<p>第七种，ROUND_HALF_EVEN，向“最接近的”数字舍入。这种算法叫做银行家算法，具体规则是，四舍六入，五则看前一位，如果是偶数舍入，如果是奇数进位，比如 5.5 -&gt; 6，2.5 -&gt; 2。</p>
<p>第八种，ROUND_UNNECESSARY，假设请求的操作具有精确的结果，也就是不需要进行舍入。如果计算结果产生不精确的结果，则抛出 ArithmeticException。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6-空指针异常">6 空指针异常<a class="hash-link" aria-label="6 空指针异常的直接链接" title="6 空指针异常的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#6-空指针异常">​</a></h2>
<p>针对判空，通过 Optional 配合 Stream 可以避免大多数冗长的 if-else 判空逻辑，实现一行代码优雅判空。另外，要定位和修复空指针异常，除了可以通过增加日志进行排查外，在生产上使用 Arthas 来查看方法的调用栈和入参会更快捷。</p>
<p>业务系统最基本的标准是不能出现未处理的空指针异常，因为它往往代表了业务逻辑的中断，所以我建议每天查询一次生产日志来排查空指针异常，有条件的话建议订阅空指针异常报警，以便及时发现及时处理。</p>
<p>POJO 中字段的 null 定位，从服务端的角度往往很难分清楚，到底是客户端希望忽略这个字段还是有意传了 null，因此我们尝试用 Optional类来区分 null 的定位。同时，为避免把空值更新到数据库中，可以实现动态 SQL，只更新必要的字段。</p>
<p>数据库字段使用 NULL 可能会带来的三个坑（包括 sum 函数、count 函数，以及 NULL 值条件），以及解决方式。</p>
<blockquote>
<ul>
<li>MySQL 中 sum 函数没统计到任何记录时，会返回 null 而不是 0，可以使用 IFNULL 函数把 null 转换为 0；</li>
<li>MySQL 中 count 字段不统计 null 值，COUNT(*) 才是统计所有记录数量的正确方式。</li>
<li>MySQL 中使用诸如 =，<code>&lt;</code>, <code>&gt;</code> 这样的算数比较操作符比较 NULL 的结果总是 NULL，这种比较就显得没有任何意义，需要使用 IS NULL，IS NOT NULL 或 ISNULL() 函数来比较。</li>
</ul>
</blockquote>
<p>总结来讲，null 的正确处理以及避免空指针异常，绝不是判空这么简单，还要根据业务属性从前到后仔细考虑，客户端传入的 null 代表了什么，出现了 null 是否允许使用默认值替代，入库的时候应该传入 null 还是空值，并确保整个逻辑处理的一致性，才能尽量避免 Bug。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7-异常处理问题">7 异常处理问题<a class="hash-link" aria-label="7 异常处理问题的直接链接" title="7 异常处理问题的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#7-异常处理问题">​</a></h2>
<blockquote>
<p>首先，不应该用 AOP 对所有方法进行统一异常处理，异常要么不捕获不处理，要么根据不同的业务逻辑、不同的异常类型进行精细化、针对性处理；其次，处理异常应该杜绝生吞，并确保异常栈信息得到保留；最后，如果需要重新抛出异常的话，请使用具有意义的异常类型和异常消息。</p>
<p>第二，务必小心 finally 代码块中资源回收逻辑，确保 finally 代码块不出现异常，内部把异常处理完毕，避免 finally 中的异常覆盖 try 中的异常；或者考虑使用 addSuppressed 方法把 finally 中的异常附加到 try 中的异常上，确保主异常信息不丢失。此外，使用实现了 AutoCloseable 接口的资源，务必使用 try-with-resources 模式来使用资源，确保资源可以正确释放，也同时确保异常可以正确处理。</p>
<p>第三，虽然在统一的地方定义收口所有的业务异常是一个不错的实践，但务必确保异常是每次 new 出来的，而不能使用一个预先定义的 static 字段存放异常，否则可能会引起栈信息的错乱。</p>
<p>第四，确保正确处理了线程池中任务的异常，如果任务通过 execute 提交，那么出现异常会导致线程退出，大量的异常会导致线程重复创建引起性能问题，我们应该尽可能确保任务不出异常，同时设置默认的未捕获异常处理程序来兜底；如果任务通过 submit 提交意味着我们关心任务的执行结果，应该通过拿到的 Future 调用其 get 方法来获得任务运行结果和可能出现的异常，否则异常可能就被生吞了。</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="71-关于在-finally-代码块中抛出异常的坑如果在-finally-代码块中返回值 你觉得程序会以-try-或-catch-中的返回值为准还是以-finally-中的返回值为准呢">7.1 关于在 finally 代码块中抛出异常的坑，如果在 finally 代码块中返回值，你觉得程序会以 try 或 catch 中的返回值为准，还是以 finally 中的返回值为准呢？<a class="hash-link" aria-label="7.1 关于在 finally 代码块中抛出异常的坑，如果在 finally 代码块中返回值，你觉得程序会以 try 或 catch 中的返回值为准，还是以 finally 中的返回值为准呢？的直接链接" title="7.1 关于在 finally 代码块中抛出异常的坑，如果在 finally 代码块中返回值，你觉得程序会以 try 或 catch 中的返回值为准，还是以 finally 中的返回值为准呢？的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#71-关于在-finally-代码块中抛出异常的坑如果在-finally-代码块中返回值你觉得程序会以-try-或-catch-中的返回值为准还是以-finally-中的返回值为准呢">​</a></h3>
<p>以 finally 中的返回值为准。</p>
<p>从语义上来说，finally 是做方法收尾资源释放处理的，我们不建议在 finally 中有 return，这样逻辑会很混乱。这是因为，实现上 finally 中的代码块会被复制多份，分别放到 try 和 catch 调用 return 和 throw 异常之前，所以 finally 中如果有返回值，会覆盖 try 中的返回值。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="8-时间相关问题">8 时间相关问题<a class="hash-link" aria-label="8 时间相关问题的直接链接" title="8 时间相关问题的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#8-时间相关问题">​</a></h2>
<p>对于国际化（世界各国的人都在使用）的项目，处理好时间和时区问题首先就是要正确保存日期时间。这里有两种保存方式：</p>
<ul>
<li>方式一，以 UTC 保存，保存的时间没有时区属性，是不涉及时区时间差问题的世界统一时间。我们通常说的时间戳，或 Java 中的 Date 类就是用的这种方式，这也是推荐的方式。</li>
<li>方式二，以字面量保存，比如年 / 月 / 日 时: 分: 秒，一定要同时保存时区信息。只有有了时区信息，我们才能知道这个字面量时间真正的时间点，否则它只是一个给人看的时间表示，只在当前时区有意义。Calendar 是有时区概念的，所以我们通过不同的时区初始化 Calendar，得到了不同的时间。</li>
</ul>
<p>在使用时间格式时，推荐使用 Java8 提供的新的时间格式。</p>
<p></p><div class="zjImgContainer_kJPg"><img decoding="async" loading="lazy" src="https://img.zbus.top//zbus/blog/202309250023830.webp" alt="" class="img_CujE"></div><p></p>
<p>这里有个误区是，认为 java.util.Date 类似于新 API 中的 LocalDateTime。其实不是，虽然它们都没有时区概念，但 java.util.Date 类是因为使用 UTC 表示，所以没有时区概念，其本质是时间戳；而 LocalDateTime，严格上可以认为是一个日期时间的表示，而不是一个时间点。</p>
<p>因此，在把 Date 转换为 LocalDateTime 的时候，需要通过 Date 的 toInstant 方法得到一个 UTC 时间戳进行转换，并需要提供当前的时区，这样才能把 UTC 时间转换为本地日期时间（的表示）。反过来，把 LocalDateTime 的时间表示转换为 Date 时，也需要提供时区，用于指定是哪个时区的时间表示，也就是先通过 atZone 方法把 LocalDateTime 转换为 ZonedDateTime，然后才能获得 UTC 时间戳：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button><button type="button" class="clean-btn" aria-label="切换自动换行" title="切换自动换行"><svg viewBox="0 0 24 24" class="wordWrapButtonIcon_iowe" aria-hidden="true"><path fill="currentColor" d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3l3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"></path></svg></button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token class-name" style="color:#e6db74">Date</span><span class="token plain"> in </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Date</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">LocalDateTime</span><span class="token plain"> ldt </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">LocalDateTime</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">ofInstant</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">in</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">toInstant</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ZoneId</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">systemDefault</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token class-name" style="color:#e6db74">Date</span><span class="token plain"> out </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Date</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">from</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ldt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">atZone</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">ZoneId</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">systemDefault</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">toInstant</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9-使用-final-修饰使用到的变量和不使用-final-修饰使用到的变量有些什么样的优缺点">9 使用 final 修饰使用到的变量和不使用 final 修饰使用到的变量有些什么样的优缺点<a class="hash-link" aria-label="9 使用 final 修饰使用到的变量和不使用 final 修饰使用到的变量有些什么样的优缺点的直接链接" title="9 使用 final 修饰使用到的变量和不使用 final 修饰使用到的变量有些什么样的优缺点的直接链接" href="/docs/java/01-Javaji-chu-zhi-shi#9-使用-final-修饰使用到的变量和不使用-final-修饰使用到的变量有些什么样的优缺点">​</a></h2>
<p>在 Java 编程中，使用 <code>final</code> 关键字修饰变量可以提供以下优点：</p>
<ol>
<li>增强代码可读性：使用 <code>final</code> 表示一个变量在定义之后不会被重新赋值，这可以更清晰地表达变量的意图。这有助于增强代码的可读性和可维护性。</li>
<li>改进程序性能：由于 JVM 能够优化对不可变（即 <code>final</code>）变量的访问，因此使用 <code>final</code> 可以改善 程序的性能。</li>
<li>追求更好的安全性：使用 <code>final</code> 可以防止在代码执行期间对变量进行更改。这可能会增强系统的安全性，防止出现潜在的问题。</li>
</ol>
<p>而对于没有使用 <code>final</code> 修饰的变量，主要缺点如下：</p>
<ol>
<li>可能影响代码可读性：如果变量被多次重新赋值，则代码的含义可能变得复杂和难以理解，这可能会降低代码的可读性。</li>
<li>可能引发并发问题：在多线程环境中，未经过同步处理的非 <code>final</code> 变量可能会引发并发问题，例如竞态条件或数据竞争等问题。</li>
<li>可能导致性能问题：由于 JVM 不能对未经过 <code>final</code> 修饰的变量进行优化，因此可能会对程序的性能产生负面影响。</li>
</ol>
<p>需要注意的是，是否使用 <code>final</code> 取决于变量的用途和上下文。在某些情况下，如果一个变量只是临时使用，或者它的值需要反复修改，则可能没有必要使用 <code>final</code> 修饰。但是，在某些情况下，使用 <code>final</code> 可以提供明显的优势，并且被认为是一种最佳实践。</p>
<blockquote>
<p><strong>补充，针对 JVM 是如何优化对不可变（即 <code>final</code>）变量的访问问题：</strong></p>
<p>JVM 在访问 <code>final</code> 变量时，可以采取一些优化措施来提升程序的性能。下面是一些 JVM 优化 <code>final</code> 变量访问的方法：</p>
<ol>
<li>内联操作：JVM 可以在编译时对代码进行内联操作，即将方法调用替换为实际的代码。如果变量被定义为 <code>final</code>，则 JVM 可以确定该变量不会在运行期间改变，因此可以更安全地进行内联操作。</li>
<li>常量折叠：JVM 可以对编译期常量进行折叠操作，即将相同的常量合并为一个常量。对于 <code>final</code> 变量，JVM 可以在编译时将其解析为常量，并在需要时直接读取值，而 无需每次访问变量时都进行解析。</li>
<li>偏向锁优化：JVM 中的偏向锁机制可以优化 <code>final</code> 变量的访问。当只有一个线程访问一个对象时，JVM 可以将该对象加入到偏向锁状态中，从而避免了在获取锁时的额外开销。由于 <code>final</code> 变量在创建之后不会被修改，因此可以使用偏向锁进行优化。</li>
</ol>
<p>总的来说，使用 <code>final</code> 修饰变量可以使 JVM 更容易对程序进行优化，提高程序的性能和可靠性。但需要注意的是，这些优化可能并不总是适用于所有情况，具体取决于程序的实际需求和上下文。</p>
</blockquote></div><div class="noticeCardContainer_M8qB"><div class="theme-admonition theme-admonition-danger admonition_Gfwi alert alert--danger"><div class="admonitionHeading_f1Ed"><span class="admonitionIcon_kpSf">💡</span>本文声明</div><div class="admonitionContent_UjKb"><p>转载请注明出处，谢谢合作！转载本文请声明原文章链接如下:</p><p><strong>原文链接: </strong><a href="https://zbus.top/docs/java/01-Javaji-chu-zhi-shi">https://zbus.top/docs/java/01-Javaji-chu-zhi-shi</a></p><p><strong>作者: </strong><a href="https://zbus.top">Z 不殊</a></p><p><a href="https://zbus.top" target="_blank" rel="noopener noreferrer">Z 不殊</a> 致力于分享有价值的信息和知识。我们尊重并保护知识产权。本文仅代表作者观点，不代表任何立场。 如果本文有所侵权，请联系作者删除或修改！</p></div></div></div><div>Loading Comments...</div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_d0Lz tagRegular_bmnp" href="/docs/tags/java">java</a></li><li class="tag_QGVx"><a class="tag_d0Lz tagRegular_bmnp" href="/docs/tags/后端">后端</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link border-2 border-link hover:bg-[#a1d8f71b] pagination-nav__link--prev" href="/docs/category/java-基础"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Java 基础</div></a><a class="pagination-nav__link border-2 border-link hover:bg-[#a1d8f71b] pagination-nav__link--next" href="/docs/java/02-javazheng-ze-biao-da-shi"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">02-java正则表达式</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#1-注意-equals-和--的区别">1. 注意 equals 和 == 的区别</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#2-integer-的内部做了缓存-">2. Integer 的内部做了缓存 。</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#3--getclass-和-instanceof-的区别">3.  getClass 和 instanceof 的区别</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#4-string-相关">4. String 相关</a><ul><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#41-string-长度限制">4.1 String 长度限制</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#5-危险的-double--bigdecimal">5 “危险”的 Double--BigDecimal</a><ul><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#51-使用-bigdecimal-表示和计算浮点数且务必使用字符串的构造方法来初始化-bigdecimal">5.1 使用 BigDecimal 表示和计算浮点数，且务必使用字符串的构造方法来初始化 BigDecimal</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#52-浮点数的字符串格式化也要通过-bigdecimal-进行">5.2 <strong>浮点数的字符串格式化也要通过 BigDecimal 进行。</strong></a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#53-用-equals-做判等注意bigdecimal-的判等方式">5.3 用 equals 做判等，注意BigDecimal 的判等方式。</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#54-小心数值溢出问题">5.4 小心数值溢出问题</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#55-bigdecimal提供了-8-种舍入模式">5.5 BigDecimal提供了 8 种舍入模式</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#6-空指针异常">6 空指针异常</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#7-异常处理问题">7 异常处理问题</a><ul><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#71-关于在-finally-代码块中抛出异常的坑如果在-finally-代码块中返回值你觉得程序会以-try-或-catch-中的返回值为准还是以-finally-中的返回值为准呢">7.1 关于在 finally 代码块中抛出异常的坑，如果在 finally 代码块中返回值，你觉得程序会以 try 或 catch 中的返回值为准，还是以 finally 中的返回值为准呢？</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#8-时间相关问题">8 时间相关问题</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/java/01-Javaji-chu-zhi-shi#9-使用-final-修饰使用到的变量和不使用-final-修饰使用到的变量有些什么样的优缺点">9 使用 final 修饰使用到的变量和不使用 final 修饰使用到的变量有些什么样的优缺点</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">总结类</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">文档</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/blog">博客</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/project">项目</a></li></ul></div><div class="col footer__col"><div class="footer__title">交流社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/friends">友链</a></li><li class="footer__item">
                                    <a href="https://docusaurus.io/zh-CN/" target="_blank" rel="noreferrer noopener">
                                      <img src="/img/buildwith.png" alt="build with docusaurus" width="120" height="50">
                                    <a>
                                    </a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
            <p style="margin-bottom: 0;"><a href="http://beian.miit.gov.cn/">京ICP备2023022073号-1</a></p>
        <p style="display: inline-flex; align-items: center;"><img style="height:20px;margin-right: 0.5rem;" src="/img/police.png" alt="police" height="20"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010802044104">京公网安备11010802044104号</a></p>
        <p>Copyright © 2024 - PRESENT Z不殊 Built with Docusaurus.</p>
            </div></div></div></footer></div>
</body>
</html>