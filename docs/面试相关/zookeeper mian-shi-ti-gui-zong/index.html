<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-面试相关/2024-05-13-00-19-58-zookeeper mian-shi-ti-gui-zong" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">zookeeper 面试题归总 | Z 不殊</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zbus.top/docs/面试相关/zookeeper mian-shi-ti-gui-zong"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="zookeeper 面试题归总 | Z 不殊"><meta data-rh="true" name="description" content="img"><meta data-rh="true" property="og:description" content="img"><meta data-rh="true" property="og:image" content="https://img.zbus.top/zbus/blog202403150754487.webp"><meta data-rh="true" name="twitter:image" content="https://img.zbus.top/zbus/blog202403150754487.webp"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zbus.top/docs/面试相关/zookeeper mian-shi-ti-gui-zong"><link data-rh="true" rel="alternate" href="https://zbus.top/docs/面试相关/zookeeper mian-shi-ti-gui-zong" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://zbus.top/docs/面试相关/zookeeper mian-shi-ti-gui-zong" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KNKL89273C-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-141789564-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Z 不殊" href="/opensearch.xml">


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?3fe9ea74bd372ee22bcbf0caaf670701";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<link rel="icon" href="/img/logo.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#12affa">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Z 不殊 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Z 不殊 Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Z 不殊 JSON Feed">

<meta name="Z 不殊" content="Z 不殊的个人博客">
<meta name="快跑小火车" content="Z 不殊的个人博客">
<meta name="baidu-site-verification" content="codeva-q5wJCLbMma">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/misans@4.0.0/lib/Normal/MiSans-Normal.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/misans@4.0.0/lib/Normal/MiSans-Semibold.min.css"><link rel="stylesheet" href="/assets/css/styles.d849ed05.css">
<script src="/assets/js/runtime~main.256fe4b1.js" defer="defer"></script>
<script src="/assets/js/main.1b751bef.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo.jpg" alt="Z 不殊 Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/logo.jpg" alt="Z 不殊 Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Z 不殊</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">文档</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/blog">博客</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/blog">博客列表</a></li><li><a class="dropdown__link" href="/blog/archive">归档</a></li></ul></div><a class="navbar__item navbar__link" href="/friends">友链</a><a class="navbar__item navbar__link" href="/project">项目</a><a class="navbar__item navbar__link" href="/about">关于我</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zhoujun134" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/logo.jpg" alt="Z 不殊 Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/logo.jpg" alt="Z 不殊 Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b>Z 不殊</b></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">介绍</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/刷题笔记">刷题笔记</a><button aria-label="展开侧边栏分类 &#x27;刷题笔记&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/java-基础">Java 基础</a><button aria-label="展开侧边栏分类 &#x27;Java 基础&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/分布式服务">分布式服务</a><button aria-label="展开侧边栏分类 &#x27;分布式服务&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/docusaurus-魔改之路">Docusaurus 魔改之路</a><button aria-label="展开侧边栏分类 &#x27;Docusaurus 魔改之路&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/git-使用手册">git 使用手册</a><button aria-label="展开侧边栏分类 &#x27;git 使用手册&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/flexmark框架">flexmark框架</a><button aria-label="展开侧边栏分类 &#x27;flexmark框架&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/nginx">nginx</a><button aria-label="展开侧边栏分类 &#x27;nginx&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/后端面试相关java">后端面试相关（java）</a><button aria-label="折叠侧边栏分类 &#x27;后端面试相关（java）&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/面试相关/redis xiang-guan-mian-shi-ti-gui-zong">redis 相关面试题归总</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong">zookeeper 面试题归总</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/linux">linux</a><button aria-label="展开侧边栏分类 &#x27;linux&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/工具日志">工具日志</a><button aria-label="展开侧边栏分类 &#x27;工具日志&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/前端">前端</a><button aria-label="展开侧边栏分类 &#x27;前端&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/后端面试相关java"><span itemprop="name">后端面试相关（java）</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">zookeeper 面试题归总</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>zookeeper 面试题归总</h1></header><p></p><div class="zjImgContainer_kJPg"><img decoding="async" loading="lazy" src="https://img.zbus.top/zbus/blog202405102244410.jpg" alt="img" class="img_CujE"></div><p></p>
<p>Zookeeper 是个数据库，文件存储系统，并且有监听通知机制（观察者模式）</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-zookeeper-集群如何进行故障迁移">1 zookeeper 集群如何进行故障迁移？<a class="hash-link" aria-label="1 zookeeper 集群如何进行故障迁移？的直接链接" title="1 zookeeper 集群如何进行故障迁移？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#1-zookeeper-集群如何进行故障迁移">​</a></h2>
<p>ZooKeeper处理节点的故障转移通过选举新的Leader节点来完成。ZooKeeper集群中的每个节点都有一个状态，可以是Leader、Follower或Observer。当Leader节点出现故障时，集群中的其他节点会开始一个新的Leader选举过程。选举规则是，节点会向其他节点发送一个请求，请求得到超过半数节点的认可后，该节点就成为新的Leader。</p>
<p>一旦新的Leader节点选举成功，集群中的所有节点都会知道新的Leader节点是谁，然后继续处理客户端请求。 在这个过程中，ZooKeeper保持了数据的一致性和可用性，确保集群的正常运行。当故障节点恢复后，它会重新加入集群并成为Follower节点，继续参与集群的工作。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-zookeeper-有遇到过节点过多的情况吗">2 zookeeper 有遇到过节点过多的情况吗？<a class="hash-link" aria-label="2 zookeeper 有遇到过节点过多的情况吗？的直接链接" title="2 zookeeper 有遇到过节点过多的情况吗？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#2-zookeeper-有遇到过节点过多的情况吗">​</a></h2>
<p>zookeeper的一个目录下的znode节点过多，导致在执行ls 和rmr命令的时候，直接终止会话退出，无法递归删除下面的子节点，具体情况如下（生产环境的zookeeper是clickhouse的元数据管理集群，有一个故障是clickhouse副本同步堆积问题），接下来的操作需要知道这个子节点中的znode有序节点是怎么命名的，一般都是‘节点名称-000000xxxxxx’，由于无法获取子节点的列表，所以需要通过循环删除节点找到，大概的区间，然后再逐条尝试删除node</p>
<p>这边写了一个jave的操作代码如下</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">org</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">apache</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">zookeeper</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import class-name" style="color:#e6db74">KeeperException</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">org</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">apache</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">zookeeper</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import class-name" style="color:#e6db74">WatchedEvent</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">org</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">apache</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">zookeeper</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import class-name" style="color:#e6db74">Watcher</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">org</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">apache</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">zookeeper</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import class-name" style="color:#e6db74">ZooKeeper</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">java</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import namespace" style="color:rgb(178, 204, 214);opacity:0.7">io</span><span class="token import namespace punctuation" style="color:#f8f8f2;opacity:0.7">.</span><span class="token import class-name" style="color:#e6db74">IOException</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">DeleChildNode</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">main</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">String</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IOException</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">InterruptedException</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">KeeperException</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">0</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> args</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;没有zkurl和zkpath参数，自动退出，参数样例：127.0.0.1:2181 /clickhouse/2/table/host/replices/queue/ 10000 9999999999 10001&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">exit</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;zkurl:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> args</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;\tzkpath:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> args</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;\t起始位置：&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> args</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;\t结束位置：&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> args</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">3</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;\t步长：&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> args</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">4</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">ZooKeeper</span><span class="token plain"> zk </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ZooKeeper</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">500000</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Watcher</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token comment" style="color:#8292a2;font-style:italic">// 监控所有被触发的事件</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">process</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">WatchedEvent</span><span class="token plain"> event</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                </span><span class="token comment" style="color:#8292a2;font-style:italic">// dosomething</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                </span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;成功建立监听连接。。。&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">String</span><span class="token plain"> t</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> start </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Integer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">parseInt</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">2</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> end </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Integer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">parseInt</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">3</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> length </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Integer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">parseInt</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">4</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">String</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">String</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> zore </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#a6e22e">&quot;0&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;00&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;000&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;0000&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;00000&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">int</span><span class="token plain"> i </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> start</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> i </span><span class="token operator" style="color:#66d9ef">&lt;</span><span class="token plain"> end</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> i </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> i </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> length</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                t </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> i </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;&quot;</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                queue </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;queue-&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> zore</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">10</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain"> t</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">length</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> t</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token comment" style="color:#8292a2;font-style:italic">//                System.out.println(args[1] + queue);</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                zk</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">delete</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                </span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;success：&quot;</span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain">args</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                </span><span class="token class-name" style="color:#e6db74">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#a6e22e">&quot;fail：&quot;</span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain">e</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">getMessage</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        zk</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">close</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-什么事-cap-定理">3 什么事 CAP 定理？<a class="hash-link" aria-label="3 什么事 CAP 定理？的直接链接" title="3 什么事 CAP 定理？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#3-什么事-cap-定理">​</a></h2>
<p>CAP（Consistency（一致性）、Availability（可用性）、Partition tolerance（分区容错性））是分布式系统中的三个重要特性。分布式系统要满足CAP中的两个特性，但无法同时满足三个特性，只能在C、A、P中选择两个。</p>
<p>一致性（Consistency）：指的是分布式系统中所有的节点在同一时间具有相同的数据副本，即更新操作成功并返回客户端后，所有的节点访问数据的结果都是一致的。
可用性（Availability）：指系统提供的服务必须一直处于可用状态，即使出现了部分故障，也不能影响系统的正常运行。
分区容错性（Partition tolerance）：指系统能够在网络分区的情况下，仍能保证一致性和可用性。
在分布式系统中，由于网络延迟、节点故障等原因，可能会出现数据不一致的情况。因此，在设计分布式系统时，需要根据实际 情况，权衡C、A、P三个特性，选择最适合自己的方案。</p>
<p>ZooKeeper保证的是一致性和分区容错性，ZooKeeper不能保证每次服务请求的可⽤
性，在极端环境下，ZooKeeper可能会丢弃⼀些请求，消费者程序需要重新请求才能获得结果。
另外在进⾏leader选举时集群都是不可⽤，所以说，ZooKeeper不能保证服务可⽤性</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-什么是-zab-协议">4 什么是 ZAB 协议<a class="hash-link" aria-label="4 什么是 ZAB 协议的直接链接" title="4 什么是 ZAB 协议的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#4-什么是-zab-协议">​</a></h2>
<p>ZAB（ZooKeeper Atomic Broadcast）协议是ZooKeeper的核心算法，用于保证ZooKeeper集群的数据一致性和高可用性。</p>
<p>在ZooKeeper中，所有的数据操作都必须经过ZAB协议进行广播，然后由所有的服务器按照相同的顺序执行，从而保证集群中所有服务器的数据状态是一致的。ZAB协议主要包括两个阶段：
1.Leader选举阶段：集群中的所有服务器通过竞选Leader的方式，选出一个Leader来负责数据的同步和更新。
2.数据同步阶段：Leader负责将客户端的请求广播给集群中的所有服务器，并根据一定的顺序进行数据同步和更新。</p>
<p>ZAB协议的核心思想是，保证集群中所有服务器的数据状态是一致的，并且在Leader故障时能够快速选举新的Leader，从而保证集群的高可用性。</p>
<p>什么是Zab</p>
<p>Zab（Zookeeper Atomic Broadcast）是为ZooKeeper协设计的崩溃恢复原子广播协议，
它保证Zookeeper集群数据的一致性和命令的全局有序性</p>
<p>zab在广播状态中保证以下特征:<br>
<strong>可靠传递:</strong>  如果消息m由一台服务器传递，那么它最终将由所有服务器传递。
<strong>全局有序:</strong>  如果一个消息a在消息b之前被一台服务器交付，那么所有服务器都交付了a和b，并且a先于b。
<strong>因果有序:</strong>  如果消息a在因果上先于消息b并且二者都被交付，那么a必须排在b之前。</p>
<p>有序性是zab协议必须要保证的一个很重要的属性，因为zookeeper是以类似目录结构的数据结构存储数据的，必须要求命名的有序性</p>
<p>比如一个命名a创建路径为/test，然后命名b创建路径为/test/123，如果不能保证有序性b命名在a之前，b命令会因为父节点不存在而创建失败。</p>
<p>整个写请求类似一个二阶段的提交。当收到客户端的写请求的时候会经历以下几个步骤：</p>
<ol>
<li>Leader收到客户端的写请求，生成一个事务（Proposal），其中包含了zxid；</li>
<li>Leader开始广播该事务，需要注意的是所有节点的通讯都是由一个FIFO的队列维护的；</li>
<li>Follower接受到事务之后，将事务写入本地磁盘，写入成功之后返回Leader一个ACK；</li>
<li>Leader收到过半的ACK之后，开始提交本事务，并广播事务提交信息</li>
<li>从节点开始提交本事务。</li>
</ol>
<p>由以上流程可知，zookeeper通过二阶段提交来保证集群中数据的一致性，因为只需要收到过半的ACK
就可以提交事务，所以zookeeper的数据并不是强一致性。
zab协议的有序性保证是通过几个方面来体现的，第一是，服务之前⽤TCP协议进行通讯，保证在网络
传输中的有序性；第二，节点之前都维护了一个FIFO的队列，保证全局有序性；第三，通过全局递增的zxid保证因果有序性。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-简述leader选举算法和流程">5 简述Leader选举算法和流程<a class="hash-link" aria-label="5 简述Leader选举算法和流程的直接链接" title="5 简述Leader选举算法和流程的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#5-简述leader选举算法和流程">​</a></h2>
<p>选举算法和流程：FastLeaderElection (默认提供的选举算法)</p>
<p>⽬前有5台服务器，每台服务器均没有数据，它们的编号分别是1,2,3,4,5,按编号依次启动，它们的选择举过程如下：
一：服务器1启动，给⾃⼰投票，然后发投票信息，由于其它机器还没有启动所以它收不到反馈信息，
服务器1的状态⼀直属于Looking。</p>
<p>二：服务器2启动，给⾃⼰投票，同时与之前启动的服务器1交换结果，由于服务器2的编号⼤所以服务
器2胜出，但此时投票数没有⼤于半数，所以两个服务器的状态依然是LOOKING。</p>
<p>三：服务器3启动，给⾃⼰投票，同时与之前启动的服务器1,2交换信息，由于服务器3的编号最⼤所以
服务器3胜出，此时投票数正好⼤于半数，所以服务器3成为leader，服务器1,2成为follower。</p>
<p>四：服务器4启动，给⾃⼰投票，同时与之前启动的服务器1,2,3交换信息，尽管服务器4的编号⼤，但之前服务器3已经胜出，所以服务器4只能成为follower。</p>
<p>五：服务器5启动，后⾯的逻辑同服务器4成为follower。</p>
<p>如果一个节点收到了超过一半的投票，就认为自己成为了新的Leader，并开始向其他节点发送消息，宣布自己是Leader，并开始接受客户端的请求。如果没有节点收到超过一半的投票，选举失败，需要重新开始新一轮的Leader选举。</p>
<p>总之，Leader选举算法的目的是为了在集群中选出一个节点成为Leader，保证系统的高可用性和数据一致性。它的流程是一个不断循环的过程，直到选出一个新的Leader或者选举失败</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6-zookeeper-中有几种节点类型">6 Zookeeper 中有几种节点类型？<a class="hash-link" aria-label="6 Zookeeper 中有几种节点类型？的直接链接" title="6 Zookeeper 中有几种节点类型？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#6-zookeeper-中有几种节点类型">​</a></h2>
<p>在Zookeeper中，有以下几种节点类型：</p>
<p>1.持久节点（Persistent Nodes）：这种节点在创建后，会一直存在于Zookeeper中，直到被显示删除。</p>
<p>2.临时节点（Ephemeral Nodes）：这种节点在创建它的客户端会话结束时被自动删除。如果客户端因为某种原因（比如网络问题）而断开连接，那么与之关联的临时节点也会被删除。</p>
<p>3.持久顺序节点（Persistent Sequential Nodes）：这种节点在创建时会自动分配一个递增的编号，编号是唯一的。节点的名称是由用户指定的前缀和分配的编号组成的。这种节点的特点是它们在同级节点中按照编号的顺序排列。</p>
<p>4.临时顺序节点（Ephemeral Sequential Nodes）：这种节点结合了临时节点和持久顺序节点的特点。它们在客户端会话结束时被删除，并按照编号的顺序排列。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7-zookeeper-的-watcher-机制是怎样的">7 Zookeeper 的 watcher 机制是怎样的？<a class="hash-link" aria-label="7 Zookeeper 的 watcher 机制是怎样的？的直接链接" title="7 Zookeeper 的 watcher 机制是怎样的？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#7-zookeeper-的-watcher-机制是怎样的">​</a></h2>
<p>Zookeeper的Watcher机制是一种事件通知机制，客户端可以在创建Zookeeper节点时设置Watcher，当节点状态发生变化时，Zookeeper服务器会将事件通知到与该节点关联的所有Watcher。Watcher可以是一次性的，也可以是持久性的，即当节点发生变化时，Watcher是否仍然有效。</p>
<p>Watcher机制的实现是通过在Zookeeper服务器上注册Watcher对象，在节点状态发生变化时，Zookeeper会将事件通知到Watcher对象。客户端需要在Watcher对象的回调函数中处理事件。通常，回调函数会重新获取节点状态，  并根据新的状态进行相应的处理。</p>
<p>需要注意的是，Watcher机制并不是强一致性的，也就是说，当节点状态发生变化时，Watcher可能会得到旧的状态，而不是最新的状态。因此，在使用Watcher机制时，客户端需要自己处理这种情况，确保数据的一致性和正确性。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="8-怎么用-zookeeper-实现分布式锁">8 怎么用 zookeeper 实现分布式锁？<a class="hash-link" aria-label="8 怎么用 zookeeper 实现分布式锁？的直接链接" title="8 怎么用 zookeeper 实现分布式锁？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#8-怎么用-zookeeper-实现分布式锁">​</a></h2>
<p>在Zookeeper中实现分布式锁的一般步骤如下：</p>
<ol>
<li>
<p>在Zookeeper中创建一个临时节点，节点名称可以是锁的名称，节点数据可以是当前客户端的ID，表示该客户端获取了锁。</p>
</li>
<li>
<p>客户端获取锁时，先检查是否已经存在该锁，如果不存在，则创建该锁；如果已经存在，则等待。</p>
</li>
<li>
<p>当客户端释放锁时，删除该节点。</p>
</li>
<li>
<p>其他客户端在创建节点时，如果发现该锁已经存在，则设置Watcher，等待上一个持有锁的客户端释放锁之后，重新尝试获取锁。</p>
</li>
</ol>
<p>以下是一个简单的Java代码示例，演示了如何使用Zookeeper实现分布式锁：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">DistributedLock</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">final</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">String</span><span class="token plain"> </span><span class="token constant" style="color:#e6db74">LOCK_BASE_PATH</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;/mylock&quot;</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">static</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">final</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">String</span><span class="token plain"> </span><span class="token constant" style="color:#e6db74">LOCK_NAME_PREFIX</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;lock_&quot;</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ZooKeeper</span><span class="token plain"> zk</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">String</span><span class="token plain"> lockPath</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">DistributedLock</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">String</span><span class="token plain"> zkUrl</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">IOException</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">InterruptedException</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">KeeperException</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">zk </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ZooKeeper</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">zkUrl</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">5000</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token function" style="color:#e6db74">createLockBasePath</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">createLockBasePath</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">KeeperException</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">zk</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">exists</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token constant" style="color:#e6db74">LOCK_BASE_PATH</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">false</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">null</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            zk</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">create</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token constant" style="color:#e6db74">LOCK_BASE_PATH</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">byte</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ZooDefs</span><span class="token class-name punctuation" style="color:#f8f8f2">.</span><span class="token class-name" style="color:#e6db74">Ids</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">OPEN_ACL_UNSAFE</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">CreateMode</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">PERSISTENT</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">lock</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">KeeperException</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token class-name" style="color:#e6db74">String</span><span class="token plain"> path </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> zk</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">create</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token constant" style="color:#e6db74">LOCK_BASE_PATH</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;/&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token constant" style="color:#e6db74">LOCK_NAME_PREFIX</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">byte</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#ae81ff">0</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ZooDefs</span><span class="token class-name punctuation" style="color:#f8f8f2">.</span><span class="token class-name" style="color:#e6db74">Ids</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">OPEN_ACL_UNSAFE</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">CreateMode</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token constant" style="color:#e6db74">EPHEMERAL_SEQUENTIAL</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        lockPath </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token boolean" style="color:#ae81ff">true</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token class-name" style="color:#e6db74">List</span><span class="token generics punctuation" style="color:#f8f8f2">&lt;</span><span class="token generics class-name" style="color:#e6db74">String</span><span class="token generics punctuation" style="color:#f8f8f2">&gt;</span><span class="token plain"> children </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> zk</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">getChildren</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token constant" style="color:#e6db74">LOCK_BASE_PATH</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#ae81ff">false</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token class-name" style="color:#e6db74">String</span><span class="token plain"> minChild </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Collections</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">min</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">children</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">lockPath</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">endsWith</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">minChild</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                </span><span class="token class-name" style="color:#e6db74">String</span><span class="token plain"> prevChild </span><span class="token operator" style="color:#66d9ef">=</span><span class="token plain"> children</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">get</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">children</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">indexOf</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">lockPath</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">substring</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token constant" style="color:#e6db74">LOCK_BASE_PATH</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">length</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token plain"> </span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                zk</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">exists</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token constant" style="color:#e6db74">LOCK_BASE_PATH</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&quot;/&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">+</span><span class="token plain"> prevChild</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">new</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">LockWatcher</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">unlock</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">KeeperException</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        zk</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#e6db74">delete</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">lockPath</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">-</span><span class="token number" style="color:#ae81ff">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token keyword" style="color:#66d9ef">private</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">class</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">LockWatcher</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">Watcher</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token annotation punctuation" style="color:#f8f8f2">@Override</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">void</span><span class="token plain"> </span><span class="token function" style="color:#e6db74">process</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name" style="color:#e6db74">WatchedEvent</span><span class="token plain"> event</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token keyword" style="color:#66d9ef">synchronized</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#66d9ef">this</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">                </span><span class="token function" style="color:#e6db74">notifyAll</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></span><br></span></code></pre></div></div>
<p>在上述代码中，我们使用了ZooKeeper的EPHEMERAL_SEQUENTIAL节点类型来创建临时节点，并通过节点名称来实现锁。在获取锁时，会不断检查当前节点是否是最小的节点，如果不是，则等待上一个节点的Watcher通知，重新尝试获取锁。</p>
<p>需要注意的是，这只是一个简单的示例代码，实际应用中可能需要考虑更多的情况，比如节点的超时时间、异常处理等。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9-zookeeper-选举机制是怎样的">9 zookeeper 选举机制是怎样的？<a class="hash-link" aria-label="9 zookeeper 选举机制是怎样的？的直接链接" title="9 zookeeper 选举机制是怎样的？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#9-zookeeper-选举机制是怎样的">​</a></h2>
<p>Zookeeper选举机制是一种基于Paxos算法的分布式一致性算法，可以保证在集群中只有一个节点拥有写权限，从而避免了数据的不一致性问题。在Zookeeper中，选举机制的实现是通过ZAB协议（Zookeeper Atomic Broadcast）来实现的。在Zookeeper中，选举机制的过程如下：</p>
<ol>
<li>每个节点都有一个唯一的ID，称为“myid”，节点之间通过网络互相通信。</li>
<li>当集群中的某个节点失去了与其他节点的联系时，它会进入“寻找Leader”的状态。这个节点会向集群中的其他节点发起投票请求，请求其他节点选择它作为Leader。</li>
<li>其他节点在收到投票请求后，会检查请求节点的Zxid（一个节点的事务ID），如果请求节点的Zxid比它们自己的Zxid更大，则将投票给请求节点。</li>
<li>如果某个节点收到了超过一半的投票，则将自己设置为Leader，并向其他节点发送通知。</li>
<li>其他节点在收到Leader的通知后，也会将自己的状态更新为“Follower”或“Observer”，并与Leader保持同步。</li>
</ol>
<p>在 Zookeeper 的选举机制中，如果某个节点在选举中被误认为是Leader，而实际上其他节点已经选出了新的Leader，这个节点会自动放弃领导权，转为Follower或Observer状态，并与新的Leader同步数据。因此，Zookeeper 选举机制不会出现脑裂的问题。</p>
<p>需要注意的是，由于Zookeeper选举机制是基于Paxos算法实现的，因此在节点数量较多时，选举的过程可能会比较复杂和耗时。因此，在实际应用中，需要根据实际情况选择合适的节点数量和配置参数，以保证集群的可用性和性能。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="10-什么是集群角色服务状态zab-状态zxid">10 什么是集群角色，服务状态，ZAB 状态，Zxid？<a class="hash-link" aria-label="10 什么是集群角色，服务状态，ZAB 状态，Zxid？的直接链接" title="10 什么是集群角色，服务状态，ZAB 状态，Zxid？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#10-什么是集群角色服务状态zab-状态zxid">​</a></h2>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="zookeeper相关概念">zookeeper相关概念：<a class="hash-link" aria-label="zookeeper相关概念：的直接链接" title="zookeeper相关概念：的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#zookeeper相关概念">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="集群角色">集群角色<a class="hash-link" aria-label="集群角色的直接链接" title="集群角色的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#集群角色">​</a></h4>
<ol>
<li>Leader：同一时间集群总只允许有一个Leader，提供对客户端的读写功能，
负责将数据同步至各个节点；</li>
<li>Follower：提供对客户端读功能，写请求则转发给Leader处理，当Leader崩溃失联之后参与Leader
选举；</li>
<li>Observer：与Follower不同的是但不参与Leader选举。</li>
</ol>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="服务状态">服务状态<a class="hash-link" aria-label="服务状态的直接链接" title="服务状态的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#服务状态">​</a></h4>
<ol>
<li>LOOKING：当节点认为群集中没有Leader，服务器会进入LOOKING状态，
目的是为了查找或者选举Leader；</li>
<li>FOLLOWING：follower角色；</li>
<li>LEADING：leader角色；</li>
<li>OBSERVING：observer角色；</li>
</ol>
<p>可以知道Zookeeper是通过自身的状态来区分自己所属的角色，来执行自己应该的任务。</p>
<p>ZAB状态: Zookeeper还给ZAB定义的4中状态，反应Zookeeper从选举到对外提供服务的过程中的四
个步骤。 状态枚举定义：</p>
<ol>
<li>ELECTION: 集群进入选举状态，此过程会选出一个节点作为leader角色；</li>
<li>DISCOVERY：连接上leader，响应leader⼼跳，并且检测leader的角色是否更改，通过此步骤之后
选举出的leader才能执行真正职务；</li>
<li>SYNCHRONIZATION：整个集群都确认leader之后，将会把leader的数据同步到各个节点，保证整
个集群的数据一致性；</li>
<li>BROADCAST：过渡到广播状态，集群开始对外提供服务。</li>
</ol>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token keyword" style="color:#66d9ef">public</span><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">enum</span><span class="token plain"> </span><span class="token class-name" style="color:#e6db74">ZabState</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">   </span><span class="token constant" style="color:#e6db74">ELECTION</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">   </span><span class="token constant" style="color:#e6db74">DISCOVERY</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">   </span><span class="token constant" style="color:#e6db74">SYNCHRONIZATION</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">   </span><span class="token constant" style="color:#e6db74">BROADCAST</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="zxid">ZXID<a class="hash-link" aria-label="ZXID的直接链接" title="ZXID的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#zxid">​</a></h4>
<p>Zxid 是极为重要的概念，它是一个long型（64位）整数，分为两部分：纪元（epoch）部分和计数器（counter）部分，是一个全局有序的数字。 epoch 代表当前集群所属的哪个leader，leader的选举就类似一个朝代的更替，你前朝的剑不能斩本朝的官，用epoch代表当前命令的有效性，counter是一个递增的数字。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11-leader-选举什么时候进行选举规则选择流程是怎样的">11 leader 选举什么时候进行？选举规则？选择流程是怎样的？<a class="hash-link" aria-label="11 leader 选举什么时候进行？选举规则？选择流程是怎样的？的直接链接" title="11 leader 选举什么时候进行？选举规则？选择流程是怎样的？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#11-leader-选举什么时候进行选举规则选择流程是怎样的">​</a></h2>
<p>一：选举发生的时机 Leader发生选举有两个时机，一个是服务启动的时候当整个集群都没有leader节点
会进入选举状态，如果leader已经存在就会告诉该节点leader的信息，自己连接上leader，整个集群不用进入选举状态。</p>
<p>还有一个就是在服务运行中，可能会出现各种情况，服务宕机、断电、⽹络延迟很高的时候leader
都不能再对外提供服务了，所有当其他几点通过心跳检测到leader失联之后，集群也会进入选举状态。</p>
<p>二：选举规则 进入投票选举流程，怎么才能选举出leader？或者说按照什么规则来让其他节点都能选举
你当leader。</p>
<p>三： zab协议是按照几个比较规则来进行投票的筛选，如果你的票比我更好，就修改自身的投票信息，
改投你当leader。
下面代码是zookeeper投票比较规则：</p>
<div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->java<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button></div><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"> </span><span class="token keyword" style="color:#66d9ef">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">newEpoch </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> curEpoch</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">newEpoch </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> curEpoch</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">newZxid </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> curZxid</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">newZxid </span><span class="token operator" style="color:#66d9ef">==</span><span class="token plain"> curZxid</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain"> </span><span class="token operator" style="color:#66d9ef">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">newId </span><span class="token operator" style="color:#66d9ef">&gt;</span><span class="token plain"> curId</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span></span><br></span></code></pre></div></div>
<p>当其他节点的纪元比自身高投它，如果纪元相同比较自身的 zxid 的大小，选举 zxid 大的节点，这里的
zxid代表节点所提交事务最大的id，zxid越大代表该节点的数据越完整。</p>
<p>最后如果epoch和zxid都相等，则比较服务的serverId，这个Id是配置zookeeper集群所配置的，所以我
们配置zookeeper集群的时候可以把服务性能更高的集群的serverId配置大些，让性能好的机器担任
leader角色。</p>
<p>选举流程</p>
<p>时机和规则都有了，下面就是leader的选举流程：</p>
<p>所有节点第一票先选举自己当leader，将投票信息广播出去；</p>
<p>从队列中接受投票信息；</p>
<p>按照规则判断是否需要更改投票信息，将更改后的投票信息再次  广播出去；</p>
<p>判断是否有超过一半的投票选举同一个节点，如果是选举结束根据投票结果设置自己的服务状态，</p>
<p>选举结束，否则继续进入投票流程。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="12-简单介绍-zookeeper-四种服务状态和四种-zab-状态之间的状态流转">12 简单介绍 zookeeper 四种服务状态和四种 ZAB 状态之间的状态流转<a class="hash-link" aria-label="12 简单介绍 zookeeper 四种服务状态和四种 ZAB 状态之间的状态流转的直接链接" title="12 简单介绍 zookeeper 四种服务状态和四种 ZAB 状态之间的状态流转的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#12-简单介绍-zookeeper-四种服务状态和四种-zab-状态之间的状态流转">​</a></h2>
<p>简单介绍zookeeper四种服务状态和四种ZAB状态之间的状态流转</p>
<ol>
<li>服务在启动或者和leader失联之后服务状态转为LOOKING；</li>
<li>如果leader不存在选举leader，如果存在直接连接leader，此时zab协议状态为ELECTION；</li>
<li>如果有超过半数的投票选择同一台server，则leader选举结束，被选举为leader的server服务状态为
LEADING，其他server服务状态为FOLLOWING/OBSERVING；</li>
<li>所有server连接上leader，此时zab协议状态为DISCOVERY；</li>
<li>leader同步数据给learner，使各个从节点数据和leader保持一致，此时zab协议状态为
SYNCHRONIZATION；</li>
<li>同步超过一半的server之后，集群对外提供服务，此时zab状态为BROADCAST。</li>
</ol>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="13-zookeeper-的应用场景通常有哪些">13 zookeeper 的应用场景通常有哪些？<a class="hash-link" aria-label="13 zookeeper 的应用场景通常有哪些？的直接链接" title="13 zookeeper 的应用场景通常有哪些？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#13-zookeeper-的应用场景通常有哪些">​</a></h2>
<p>Zookeeper的应用场景：
服务注册与订阅（共用节点）
分布式通知（监听znode）
服务命名（znode特性）
数据订阅、发布（watcher）
分布式锁（临时节点）</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="14-zookeeper-的节点类型有哪几类">14 zookeeper 的节点类型有哪几类？<a class="hash-link" aria-label="14 zookeeper 的节点类型有哪几类？的直接链接" title="14 zookeeper 的节点类型有哪几类？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#14-zookeeper-的节点类型有哪几类">​</a></h2>
<ul>
<li>持久化节点（zk断开节点还在）</li>
<li>持久化顺序编号目录节点</li>
<li>临时目录节点（客户端断开后节点就删除了）</li>
<li>临时目录编号目录节点</li>
</ul>
<p>节点名称都是唯一的</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="15-zookeeper-的节点是如何创建">15 zookeeper 的节点是如何创建？<a class="hash-link" aria-label="15 zookeeper 的节点是如何创建？的直接链接" title="15 zookeeper 的节点是如何创建？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#15-zookeeper-的节点是如何创建">​</a></h2>
<div class="language-bash codeBlockContainer_APcc theme-code-block" style="--prism-color:#f8f8f2;--prism-background-color:#272822"><div class="codeBlockContent_m3Ux"><div class="buttonGroup_6DOT codeBlockLinesWithNumbering_OFgW"><button> <!-- -->bash<!-- --> </button><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_phi_"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_FfTR"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button><button type="button" class="clean-btn wordWrapButtonEnabled_tAnL" aria-label="切换自动换行" title="切换自动换行">折叠代码</button></div><pre tabindex="0" class="prism-code language-bash codeBlock_qGQc thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_p187 codeBlockLinesWithNumbering_OFgW"><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">// 创建永久节点</span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">create /test laogong </span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">// 创建临时节点</span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">create </span><span class="token parameter variable" style="color:#f8f8f2">-e</span><span class="token plain"> /test laogong</span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">//临时节点创建成功，如果断开链接，这个节点⾃然就消失了</span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">//创建顺序节点</span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">create </span><span class="token parameter variable" style="color:#f8f8f2">-s</span><span class="token plain"> /test</span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">// 创建临时顺序节点</span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">create </span><span class="token parameter variable" style="color:#f8f8f2">-e</span><span class="token plain"> </span><span class="token parameter variable" style="color:#f8f8f2">-s</span><span class="token plain"> /test</span></span><br></span><span class="token-line codeLine_iPqp" style="color:#f8f8f2"><span class="codeLineNumber_F4P7"></span><span class="codeLineContent_pOih"><span class="token plain">//退出后，重新连接，发现刚才创建的所有临时节点都没</span></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="16-zookeeper-怎么去保证分布式情况下的线程安全呢并发竞争他是怎么控制">16 zookeeper 怎么去保证分布式情况下的线程安全呢？并发竞争他是怎么控制？<a class="hash-link" aria-label="16 zookeeper 怎么去保证分布式情况下的线程安全呢？并发竞争他是怎么控制？的直接链接" title="16 zookeeper 怎么去保证分布式情况下的线程安全呢？并发竞争他是怎么控制？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#16-zookeeper-怎么去保证分布式情况下的线程安全呢并发竞争他是怎么控制">​</a></h2>
<p>synchronized，lock 也只能保证当前机器线程安全，分布式访问还是有问题</p>
<p>节点就可以解决这个问题。
Zookeeper节点有个唯一的特性，就是创建过这个节点，再创建Zookeeper是会报错的，那就利用它的唯一性去实现分布式线程安全</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="17-zookeeper节点怎么实现分布式多线程">17 zookeeper节点怎么实现分布式多线程？<a class="hash-link" aria-label="17 zookeeper节点怎么实现分布式多线程？的直接链接" title="17 zookeeper节点怎么实现分布式多线程？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#17-zookeeper节点怎么实现分布式多线程">​</a></h2>
<p>节点怎么实现分布式多线程。全部去创建多线程，创建成功的第一个返回true他就可以继续下面的出票操作，后续的节点访问就会全部报错，出票失败，相当于把它们丢一个队列去排队</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="18-zookeeper节点怎么释放锁">18 zookeeper节点怎么释放锁？<a class="hash-link" aria-label="18 zookeeper节点怎么释放锁？的直接链接" title="18 zookeeper节点怎么释放锁？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#18-zookeeper节点怎么释放锁">​</a></h2>
<p>怎么释放锁</p>
<p>通过删除节点实现，删了再通知其他的人过来加锁，依次类推 Lock 在 finally 里面 unLock，现在我们在finally 删除节点。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="19-zookeeperzk加锁我们知道创建节点就够了但是你得实现一个阻塞的效果呀那怎么实现">19 Zookeeperzk加锁 我们知道创建节点就够了，但是你得实现一个阻塞的效果呀，那怎么实现？<a class="hash-link" aria-label="19 Zookeeperzk加锁我们知道创建节点就够了，但是你得实现一个阻塞的效果呀，那怎么实现？的直接链接" title="19 Zookeeperzk加锁我们知道创建节点就够了，但是你得实现一个阻塞的效果呀，那怎么实现？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#19-zookeeperzk加锁我们知道创建节点就够了但是你得实现一个阻塞的效果呀那怎么实现">​</a></h2>
<p>死循环，递归不断去尝试，直到成功，一个伪装的阻塞效果</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="20-zookeeperzk怎么知道前面的老哥删除节点了呢">20 Zookeeperzk怎么知道前面的老哥删除节点了呢？<a class="hash-link" aria-label="20 Zookeeperzk怎么知道前面的老哥删除节点了呢？的直接链接" title="20 Zookeeperzk怎么知道前面的老哥删除节点了呢？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#20-zookeeperzk怎么知道前面的老哥删除节点了呢">​</a></h2>
<p>监听节点的删除事件</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="21-第一个人加锁成功了执行代码机器宕机了出现死锁那节点是不是就不能删除了">21 第一个人加锁成功了，执行代码机器宕机了出现死锁，那节点是不是就不能删除了？<a class="hash-link" aria-label="21 第一个人加锁成功了，执行代码机器宕机了出现死锁，那节点是不是就不能删除了？的直接链接" title="21 第一个人加锁成功了，执行代码机器宕机了出现死锁，那节点是不是就不能删除了？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#21-第一个人加锁成功了执行代码机器宕机了出现死锁那节点是不是就不能删除了">​</a></h2>
<p>创建临时节点就好了，客户端连接一旦断开，别的  就可以监听到节点的变化了</p>
<p>但监听机制也有不好的一面：
监听，是所有服务都去监听一个节点的，节点的释放也会通知所有的服务器，</p>
<p>如果是900个服务器呢？
这对服务器是很大的一个挑战，一个释放的消息，就好像一个牧羊犬进入了羊群，大家都四散而开，随
时可能干掉机器，会占用服务资源，网络带宽等等。这就是羊群效应</p>
<p>怎么解决监听机制的羊群效应问题？
临时顺序节点，可以顺利解决这个问题
全部监听一个节点问题很大，那我们就监听我们的前一个节点，
因为是顺序的，很容易找到自己的前后</p>
<p>和之前监听一个永久节点的区别就在于，这里每个节点只监听了自己的前一个节点，
释放当然也是一个个释放下去，就不会出现羊群效应</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="22-说说-zk-在分布式锁中实践的一些缺点">22 说说 zk 在分布式锁中实践的一些缺点？<a class="hash-link" aria-label="22 说说 zk 在分布式锁中实践的一些缺点？的直接链接" title="22 说说 zk 在分布式锁中实践的一些缺点？的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#22-说说-zk-在分布式锁中实践的一些缺点">​</a></h2>
<p>Zookeeper性能上可能并没有缓存服务那么高。</p>
<p>因为每次在创建锁和释放锁的过程中，都要动态创建、销毁瞬时节点来实现锁功能。
Zookeeper中创建和删除节点只能通过Leader服务器来执行，然后将数据同步到所有的Follower机器上。</p>
<p>使用Zookeeper也有可能带来并发问题，只是并不常见。</p>
<p>由于网络抖动，客户端可Zookeeper集群的session连接断了，那么Zookeeper以为客户端挂了，就会删除临时节点，这时候其他客户端就可以获取到分布式锁了。就可能产生并发问题了，这个问题不常见是因为Zookeeper有重试机制，一旦Zookeeper集群检测不到客户端的心跳，就会重试，Curator客户端支持多种重试策略。多次重试之后还不行的话才会删除临时节点。Tip：所以，选择一个合适的重试策略也很重要，要在锁的粒度和并发之间找一个平衡。</p>
<p>有更好的实现么？
基于Redis的分布式锁</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="23-zk-常考知识点">23 zk 常考知识点<a class="hash-link" aria-label="23 zk 常考知识点的直接链接" title="23 zk 常考知识点的直接链接" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#23-zk-常考知识点">​</a></h2>
<p>Zookeeper通过临时节点，解决掉了死锁的问题，一旦客户端获取到锁之后突然挂掉（Session连接断开），那么这个临时节点就会自动删除掉，其他客户端自动获取锁。
Zookeeper通过节点排队监听的机制，也实现了阻塞的原理，其实就是个递归在那无限等待最小节点释放的过程。</p>
<p>实现锁的可重入，可以带上线程信息就可以了，或者机器信息这样的唯一标识，获取的时候判断一下。</p>
<p>Zookeeper的集群也是高可用的，只要半数以上的或者，就可以对外提供服务了</p></div><div class="noticeCardContainer_M8qB"><div class="theme-admonition theme-admonition-danger admonition_Gfwi alert alert--danger"><div class="admonitionHeading_f1Ed"><span class="admonitionIcon_kpSf">💡</span>本文声明</div><div class="admonitionContent_UjKb"><p>转载请注明出处，谢谢合作！转载本文请声明原文章链接如下:</p><p><strong>原文链接: </strong><a href="https://zbus.top/docs/面试相关/zookeeper mian-shi-ti-gui-zong">https://zbus.top/docs/面试相关/zookeeper mian-shi-ti-gui-zong</a></p><p><strong>作者: </strong><a href="https://zbus.top">Z 不殊</a></p><p><a href="https://zbus.top" target="_blank" rel="noopener noreferrer">Z 不殊</a> 致力于分享有价值的信息和知识。我们尊重并保护知识产权。 本文仅代表作者观点，不代表任何立场。 如果本文有所侵权，请联系作者删除或修改！</p></div></div></div><div>Loading Comments...</div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_d0Lz tagRegular_bmnp" href="/docs/tags/随笔">随笔</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link border-2 border-link hover:bg-[#a1d8f71b] pagination-nav__link--prev" href="/docs/面试相关/redis xiang-guan-mian-shi-ti-gui-zong"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">redis 相关面试题归总</div></a><a class="pagination-nav__link border-2 border-link hover:bg-[#a1d8f71b] pagination-nav__link--next" href="/docs/category/linux"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">linux</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#1-zookeeper-集群如何进行故障迁移">1 zookeeper 集群如何进行故障迁移？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#2-zookeeper-有遇到过节点过多的情况吗">2 zookeeper 有遇到过节点过多的情况吗？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#3-什么事-cap-定理">3 什么事 CAP 定理？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#4-什么是-zab-协议">4 什么是 ZAB 协议</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#5-简述leader选举算法和流程">5 简述Leader选举算法和流程</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#6-zookeeper-中有几种节点类型">6 Zookeeper 中有几种节点类型？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#7-zookeeper-的-watcher-机制是怎样的">7 Zookeeper 的 watcher 机制是怎样的？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#8-怎么用-zookeeper-实现分布式锁">8 怎么用 zookeeper 实现分布式锁？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#9-zookeeper-选举机制是怎样的">9 zookeeper 选举机制是怎样的？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#10-什么是集群角色服务状态zab-状态zxid">10 什么是集群角色，服务状态，ZAB 状态，Zxid？</a><ul><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#zookeeper相关概念">zookeeper相关概念：</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#11-leader-选举什么时候进行选举规则选择流程是怎样的">11 leader 选举什么时候进行？选举规则？选择流程是怎样的？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#12-简单介绍-zookeeper-四种服务状态和四种-zab-状态之间的状态流转">12 简单介绍 zookeeper 四种服务状态和四种 ZAB 状态之间的状态流转</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#13-zookeeper-的应用场景通常有哪些">13 zookeeper 的应用场景通常有哪些？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#14-zookeeper-的节点类型有哪几类">14 zookeeper 的节点类型有哪几类？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#15-zookeeper-的节点是如何创建">15 zookeeper 的节点是如何创建？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#16-zookeeper-怎么去保证分布式情况下的线程安全呢并发竞争他是怎么控制">16 zookeeper 怎么去保证分布式情况下的线程安全呢？并发竞争他是怎么控制？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#17-zookeeper节点怎么实现分布式多线程">17 zookeeper节点怎么实现分布式多线程？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#18-zookeeper节点怎么释放锁">18 zookeeper节点怎么释放锁？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#19-zookeeperzk加锁我们知道创建节点就够了但是你得实现一个阻塞的效果呀那怎么实现">19 Zookeeperzk加锁我们知道创建节点就够了，但是你得实现一个阻塞的效果呀，那怎么实现？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#20-zookeeperzk怎么知道前面的老哥删除节点了呢">20 Zookeeperzk怎么知道前面的老哥删除节点了呢？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#21-第一个人加锁成功了执行代码机器宕机了出现死锁那节点是不是就不能删除了">21 第一个人加锁成功了  ，执行代码机器宕机了出现死锁，那节点是不是就不能删除了？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#22-说说-zk-在分布式锁中实践的一些缺点">22 说说 zk 在分布式锁中实践的一些缺点？</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/面试相关/zookeeper mian-shi-ti-gui-zong#23-zk-常考知识点">23 zk 常考知识点</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">总结类</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">文档</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/blog">博客</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/project">项目</a></li></ul></div><div class="col footer__col"><div class="footer__title">交流社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/friends">友链</a></li><li class="footer__item">
                                    <a href="https://docusaurus.io/zh-CN/" target="_blank" rel="noreferrer noopener">
                                      <img src="/img/buildwith.png" alt="build with docusaurus" width="120" height="50">
                                    <a>
                                    </a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
            <p style="margin-bottom: 0;"><a href="http://beian.miit.gov.cn/">京ICP备2023022073号-1</a></p>
        <p style="display: inline-flex; align-items: center;"><img style="height:20px;margin-right: 0.5rem;" src="/img/police.png" alt="police" height="20"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010802044104">京公网安备11010802044104号</a></p>
        <p>Copyright © 2024 - PRESENT Z不殊 Built with Docusaurus.</p>
            </div></div></div></footer></div>
</body>
</html>